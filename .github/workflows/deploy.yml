name: Deploy to Github Pages

on:
    push:
        branches:
            - main

    workflow_dispatch:

jobs:
    pages-changes:
        runs-on: ubuntu-latest

        outputs:
            changed: ${{ contains(steps.changes.outputs.changes, 'not-api') && contains(steps.changes.outputs.changes, 'not-license') && contains(steps.changes.outputs.changes, 'not-readme') && contains(steps.changes.outputs.changes, 'not-vscode') }}
        steps:
            - uses: actions/checkout@v4
            - name: Changes
              id: changes
              uses: dorny/paths-filter@v2
              with:
                  base: 'main'
                  # if a filter is false, it means that the only change matched it, so do not deploy
                  filters: |
                      not-license: '!LICENSE*'
                      not-readme: '!**/README*'
                      not-vscode: '!.vscode/**'

    build-pages:
        runs-on: ubuntu-latest
        needs: pages-changes
        if: ${{ needs.pages-changes.outputs.changed }}

        steps:
            - uses: actions/checkout@v5
            - uses: actions-rust-lang/setup-rust-toolchain@v1
              with:
                  rustflags: '-Ctarget-cpu=native'
            # Install my fork of rust-analyzer for the best Rust highlighting
            - name: Install rust-analyzer fork
              uses: baptiste0928/cargo-install@v3
              with:
                  crate: rust-analyzer
                  git: https://github.com/tsar-boomba/rust-analyzer.git
                  branch: html-highlight-opts
            - uses: pnpm/action-setup@v4
            - uses: actions/setup-node@v6
              with:
                  node-version: 20
                  cache: 'pnpm'
            - run: pnpm i --frozen-lockfile
            - run: RUST_ANALYZER=rust-analyzer pnpm build
            - name: Upload Artifact
              uses: actions/upload-pages-artifact@v3
              with:
                  path: dist/
                  retention-days: 2

    deploy-pages:
        runs-on: ubuntu-latest
        needs: [build-pages]
        if: ${{ !failure() && !cancelled() && needs.build-pages.result == 'success' }}
        permissions:
            pages: write # to deploy to Pages
            id-token: write # to verify the deployment originates from an appropriate source
        # Deploy to the github-pages environment
        environment:
            name: github-pages
            url: ${{ steps.deployment.outputs.page_url }}
        steps:
            - name: Deploy to GitHub Pages
              id: deployment
              uses: actions/deploy-pages@v4
